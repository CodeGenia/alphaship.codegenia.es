name: Encrypt and Publish to gh-pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Production 

    steps:
      - name: Checkout main
        uses: actions/checkout@v4

      - name: Descargar solo archivos necesarios
        uses: actions/checkout@v4
        with:
          repository: CodeGenia/encriptacion-landings
          token: ${{ secrets.ASSETS_REPO_TOKEN }}
          path: fixed-assets
          sparse-checkout: |
            /password-template.html
            /codegenia_logo.jpg
            /.netlifyignore
            /robots.txt
          sparse-checkout-cone-mode: false

      # Copia assets al root y limpia el directorio temporal
      - name: Copiar assets al root
        run: |
          cp -r fixed-assets/* .
          rm -rf fixed-assets

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          # cache: "npm"

      - name: Encrypt index.html
        run: |
          npx staticrypt index.html \
            --short true \
            -t password-template.html \
            -p "${{ secrets.STATICRYPT_PASSWORD }}"

          # Reemplazar el original por el encriptado
          mv encrypted/index.html index.html
          rm -rf encrypted
          # Eliminar template solo si existe
          [ -f password-template.html ] && rm password-template.html
          # Eliminar archivo de configuraciÃ³n de Staticrypt solo si existe
          [ -f .staticrypt.json ] && rm .staticrypt.json

      - name: Deploy to branch gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          force_orphan: true
          


      # -------------------------------
      # Netlify Site Creation
      # -------------------------------
      - name: Get or Create Netlify Site
        id: netlify_site
        run: |
          SITE_NAME="${{ github.event.repository.name }}"
          echo "Looking for site: $SITE_NAME"

          # Ensure jq is installed
          sudo apt-get update && sudo apt-get install -y jq


          # Try to find by site name first
          SITES_JSON=$(curl -s -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" https://api.netlify.com/api/v1/sites)
          echo "DEBUG: Netlify sites JSON: $SITES_JSON"
          EXISTING_SITE=$(echo "$SITES_JSON" | jq -r ".[] | select(.name==\"$SITE_NAME\") | .id")

          # If not found, try by custom domain
          if [ -z "$EXISTING_SITE" ]; then
            EXISTING_SITE=$(echo "$SITES_JSON" | jq -r ".[] | select(.custom_domain==\"$SITE_NAME\") | .id")
          fi

          if [ -z "$EXISTING_SITE" ]; then
            echo "Site does not exist. Creating..."
            CREATE_SITE_JSON=$(curl -s -X POST https://api.netlify.com/api/v1/sites \
              -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"name\":\"$SITE_NAME\"}")
            echo "DEBUG: Netlify create site response: $CREATE_SITE_JSON"
            SITE_ID=$(echo "$CREATE_SITE_JSON" | jq -r '.id')
          else
            echo "Site already exists."
            SITE_ID=$EXISTING_SITE
          fi

          echo "DEBUG: SITE_ID after lookup/creation: $SITE_ID"
          if [ -z "$SITE_ID" ]; then
            echo "Error: SITE_ID is empty after Netlify site creation. Exiting."
            exit 1
          fi

          echo "SITE_ID=$SITE_ID" >> $GITHUB_ENV
          echo "Using SITE_ID=$SITE_ID"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      # -------------------------------
      # Deploy to Netlify
      # -------------------------------
      - name: Deploy to Netlify
        run: |
          echo "Deploying to Netlify with SITE_ID=$SITE_ID"
          npm install -g netlify-cli@21.6.0
          netlify --version
          if [ -z "$SITE_ID" ]; then
            echo "Error: SITE_ID is empty before deploy. Exiting."
            exit 1
          fi
          netlify deploy \
            --prod \
            --dir=. \
            --site=$SITE_ID \
            --json || {
              echo "Netlify deploy failed. Check SITE_ID and permissions.";
              exit 1;
            }
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          SITE_ID: ${{ env.SITE_ID }}

      # -------------------------------
      # Associate Subdomain automatically
      # -------------------------------
      - name: Associate Subdomain via API
        run: |
          SUBDOMAIN="${{ github.event.repository.name }}"
          echo "Associating subdomain: $SUBDOMAIN"

          RESPONSE=$(curl -s -X PATCH "https://api.netlify.com/api/v1/sites/$SITE_ID" \
            -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"custom_domain\":\"$SUBDOMAIN\"}")

          echo "Response from Netlify API:"
          echo "$RESPONSE"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          SITE_ID: ${{ env.SITE_ID }}